<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ultra Doc-Intelligence</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ── Header ── */
    header {
      background: #1e293b;
      border-bottom: 1px solid #334155;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
      z-index: 10;
    }
    header .logo {
      width: 34px; height: 34px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      border-radius: 9px;
      display: flex; align-items: center; justify-content: center;
      font-size: 16px; font-weight: 700; color: #fff;
    }
    header h1 { font-size: 16px; font-weight: 600; color: #f1f5f9; }
    header .subtitle {
      font-size: 12px;
      color: #64748b;
      margin-left: -4px;
    }

    /* ── Main Layout: sidebar + chat ── */
    .layout {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* ── Left Sidebar ── */
    .sidebar {
      width: 320px;
      min-width: 320px;
      background: #1e293b;
      border-right: 1px solid #334155;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .sidebar-section {
      padding: 20px;
      border-bottom: 1px solid #334155;
    }
    .sidebar-section:last-child { border-bottom: none; }

    .sidebar-title {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #64748b;
      margin-bottom: 14px;
    }

    /* Upload zone in sidebar */
    .upload-zone {
      border: 2px dashed #475569;
      border-radius: 12px;
      padding: 28px 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: #0f172a;
    }
    .upload-zone:hover, .upload-zone.dragover {
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99,102,241,0.12);
    }
    .upload-zone .icon { font-size: 32px; margin-bottom: 10px; }
    .upload-zone h3 { font-size: 14px; font-weight: 600; margin-bottom: 4px; color: #f1f5f9; }
    .upload-zone p { font-size: 12px; color: #94a3b8; line-height: 1.4; }
    .upload-zone input { display: none; }

    /* Progress bar */
    .upload-progress {
      display: none;
      margin-top: 14px;
    }
    .upload-progress .status { font-size: 12px; color: #cbd5e1; margin-bottom: 6px; }
    .upload-progress .bar-track {
      height: 4px; background: #334155; border-radius: 2px; overflow: hidden;
    }
    .upload-progress .bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #6366f1, #8b5cf6);
      border-radius: 2px;
      width: 0%; transition: width 0.3s;
    }

    /* Active document card */
    .doc-card {
      display: none;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 16px;
    }
    .doc-card.active { display: block; }
    .doc-card .doc-icon {
      width: 40px; height: 40px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; margin-bottom: 12px;
    }
    .doc-card .doc-name {
      font-size: 14px;
      font-weight: 600;
      color: #f1f5f9;
      margin-bottom: 4px;
      word-break: break-all;
    }
    .doc-card .doc-meta {
      font-size: 12px;
      color: #94a3b8;
      display: flex;
      gap: 12px;
      margin-bottom: 14px;
    }
    .doc-card .doc-meta span {
      display: flex; align-items: center; gap: 4px;
    }
    .doc-card .doc-status {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      font-weight: 600;
      color: #6ee7b7;
      background: #064e3b;
      padding: 4px 10px;
      border-radius: 20px;
    }

    /* Sidebar actions */
    .sidebar-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .sidebar-actions button {
      width: 100%;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #334155;
      background: #0f172a;
      color: #cbd5e1;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .sidebar-actions button:hover { background: #334155; color: #f1f5f9; }
    .sidebar-actions button.primary {
      background: #4f46e5;
      border-color: #4f46e5;
      color: #fff;
    }
    .sidebar-actions button.primary:hover { background: #4338ca; }
    .sidebar-actions button .btn-icon { font-size: 16px; }

    /* Sample questions */
    .sample-questions {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .sample-q {
      padding: 8px 12px;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      font-size: 12px;
      color: #94a3b8;
      cursor: pointer;
      transition: all 0.15s;
    }
    .sample-q:hover {
      border-color: #6366f1;
      color: #c7d2fe;
      background: rgba(99,102,241,0.08);
    }

    /* ── Right: Chat Panel ── */
    .chat-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Empty state */
    .chat-empty {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #475569;
      text-align: center;
      padding: 40px;
    }
    .chat-empty.hidden { display: none; }
    .chat-empty .empty-icon { font-size: 56px; margin-bottom: 16px; opacity: 0.5; }
    .chat-empty h2 { font-size: 20px; font-weight: 600; color: #64748b; margin-bottom: 8px; }
    .chat-empty p { font-size: 14px; color: #475569; max-width: 360px; line-height: 1.5; }

    /* Messages */
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px 24px;
      display: none;
      flex-direction: column;
      gap: 16px;
    }
    .messages.active { display: flex; }
    .messages::-webkit-scrollbar { width: 6px; }
    .messages::-webkit-scrollbar-track { background: transparent; }
    .messages::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }

    .msg {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 14px;
      font-size: 14px;
      line-height: 1.6;
      word-wrap: break-word;
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .msg.user {
      align-self: flex-end;
      background: #4f46e5;
      color: #fff;
      border-bottom-right-radius: 4px;
    }
    .msg.bot {
      align-self: flex-start;
      background: #1e293b;
      border: 1px solid #334155;
      border-bottom-left-radius: 4px;
    }
    .msg.bot .answer-text { margin-bottom: 8px; }
    .msg.bot .confidence {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
    }
    .confidence.high { background: #064e3b; color: #6ee7b7; }
    .confidence.med  { background: #713f12; color: #fbbf24; }
    .confidence.low  { background: #7f1d1d; color: #fca5a5; }

    .msg.bot .source-toggle {
      display: inline-block;
      margin-left: 8px;
      font-size: 11px;
      color: #6366f1;
      cursor: pointer;
      text-decoration: underline;
    }
    .msg.bot .source-toggle:hover { color: #818cf8; }
    .msg.bot .source {
      margin-top: 8px;
      padding: 10px 12px;
      background: #0f172a;
      border-radius: 8px;
      font-size: 12px;
      color: #94a3b8;
      max-height: 100px;
      overflow-y: auto;
      white-space: pre-wrap;
      display: none;
      border: 1px solid #1e293b;
    }
    .msg.bot .source.open { display: block; }

    .msg.extract {
      align-self: flex-start;
      background: #1e293b;
      border: 1px solid #334155;
      border-bottom-left-radius: 4px;
      width: 100%;
      max-width: 100%;
    }
    .msg.extract .extract-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 10px;
      color: #f1f5f9;
    }
    .msg.extract .extract-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .extract-field {
      background: #0f172a;
      border-radius: 8px;
      padding: 10px 12px;
    }
    .extract-field .field-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #64748b;
      margin-bottom: 3px;
    }
    .extract-field .field-value {
      font-size: 13px;
      color: #e2e8f0;
      font-weight: 500;
    }
    .extract-field .field-value.null { color: #475569; font-style: italic; }

    .msg.typing {
      align-self: flex-start;
      background: #1e293b;
      border: 1px solid #334155;
      border-bottom-left-radius: 4px;
    }
    .typing-dots span {
      display: inline-block;
      width: 8px; height: 8px;
      border-radius: 50%;
      background: #6366f1;
      margin: 0 2px;
      animation: bounce 1.4s infinite both;
    }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
      40% { transform: scale(1); opacity: 1; }
    }

    /* ── Input bar ── */
    .input-bar {
      display: flex;
      gap: 10px;
      padding: 16px 24px;
      background: #1e293b;
      border-top: 1px solid #334155;
      flex-shrink: 0;
    }
    .input-bar input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid #334155;
      background: #0f172a;
      color: #f1f5f9;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }
    .input-bar input:focus { border-color: #6366f1; }
    .input-bar input::placeholder { color: #64748b; }
    .input-bar input:disabled { opacity: 0.5; cursor: not-allowed; }
    .input-bar button {
      padding: 12px 22px;
      border-radius: 10px;
      border: none;
      background: #4f46e5;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .input-bar button:hover { background: #4338ca; }
    .input-bar button:disabled { background: #334155; color: #64748b; cursor: not-allowed; }

    /* ── Responsive ── */
    @media (max-width: 768px) {
      .sidebar { width: 260px; min-width: 260px; }
      .msg { max-width: 90%; }
      .msg.extract .extract-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 600px) {
      .layout { flex-direction: column; }
      .sidebar {
        width: 100%; min-width: unset;
        max-height: 45vh;
        border-right: none;
        border-bottom: 1px solid #334155;
      }
    }
  </style>
</head>
<body>

  <header>
    <div class="logo">U</div>
    <h1>Ultra Doc-Intelligence</h1>
    <span class="subtitle">AI Document Assistant</span>
  </header>

  <div class="layout">
    <!-- ── Left Sidebar ── -->
    <aside class="sidebar">
      <!-- Upload -->
      <div class="sidebar-section">
        <div class="sidebar-title">Upload Document</div>
        <div class="upload-zone" id="uploadZone">
          <div class="icon">&#128196;</div>
          <h3>Drop file here</h3>
          <p>PDF, DOCX, or TXT</p>
          <input type="file" id="fileInput" accept=".pdf,.docx,.txt">
        </div>
        <div class="upload-progress" id="uploadProgress">
          <div class="status" id="uploadStatus">Uploading...</div>
          <div class="bar-track"><div class="bar-fill" id="uploadBar"></div></div>
        </div>
      </div>

      <!-- Active Document -->
      <div class="sidebar-section">
        <div class="sidebar-title">Active Document</div>
        <div class="doc-card" id="docCard">
          <div class="doc-icon">&#128203;</div>
          <div class="doc-name" id="docName"></div>
          <div class="doc-meta">
            <span id="docChunks"></span>
            <span id="docId"></span>
          </div>
          <div class="doc-status">&#9679; Indexed &amp; Ready</div>
        </div>
        <div id="noDocMsg" style="font-size:13px; color:#475569;">No document loaded yet.</div>
      </div>

      <!-- Actions -->
      <div class="sidebar-section" id="actionsSection" style="display:none;">
        <div class="sidebar-title">Actions</div>
        <div class="sidebar-actions">
          <button class="primary" onclick="extractData()">
            <span class="btn-icon">&#9881;</span> Extract Shipment Data
          </button>
          <button onclick="uploadNew()">
            <span class="btn-icon">&#128196;</span> Upload New Document
          </button>
        </div>
      </div>

      <!-- Sample Questions -->
      <div class="sidebar-section" id="samplesSection" style="display:none;">
        <div class="sidebar-title">Try These Questions</div>
        <div class="sample-questions">
          <div class="sample-q" onclick="askSample(this)">What is the carrier rate?</div>
          <div class="sample-q" onclick="askSample(this)">What is the shipment weight?</div>
          <div class="sample-q" onclick="askSample(this)">Who is the consignee?</div>
          <div class="sample-q" onclick="askSample(this)">When is pickup scheduled?</div>
          <div class="sample-q" onclick="askSample(this)">What is the load ID?</div>
        </div>
      </div>
    </aside>

    <!-- ── Right: Chat ── -->
    <main class="chat-panel">
      <div class="chat-empty" id="chatEmpty">
        <div class="empty-icon">&#128172;</div>
        <h2>Start a conversation</h2>
        <p>Upload a logistics document from the sidebar, then ask questions about it here.</p>
      </div>

      <div class="messages" id="messages"></div>

      <div class="input-bar">
        <input type="text" id="questionInput" placeholder="Ask a question about the document..." autocomplete="off" disabled>
        <button id="sendBtn" onclick="sendQuestion()" disabled>Send &#8594;</button>
      </div>
    </main>
  </div>

  <script>
    let currentDocId = null;
    let isBusy = false;

    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const uploadProgress = document.getElementById('uploadProgress');
    const uploadStatus = document.getElementById('uploadStatus');
    const uploadBar = document.getElementById('uploadBar');
    const docCard = document.getElementById('docCard');
    const docName = document.getElementById('docName');
    const docChunks = document.getElementById('docChunks');
    const docIdEl = document.getElementById('docId');
    const noDocMsg = document.getElementById('noDocMsg');
    const actionsSection = document.getElementById('actionsSection');
    const samplesSection = document.getElementById('samplesSection');
    const chatEmpty = document.getElementById('chatEmpty');
    const messages = document.getElementById('messages');
    const questionInput = document.getElementById('questionInput');
    const sendBtn = document.getElementById('sendBtn');

    // ── Upload ──
    uploadZone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => { if (e.target.files[0]) handleUpload(e.target.files[0]); });
    uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
    uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      if (e.dataTransfer.files[0]) handleUpload(e.dataTransfer.files[0]);
    });

    async function handleUpload(file) {
      uploadProgress.style.display = 'block';
      uploadStatus.textContent = `Uploading ${file.name}...`;
      uploadBar.style.width = '30%';

      const form = new FormData();
      form.append('file', file);

      try {
        uploadBar.style.width = '60%';
        uploadStatus.textContent = 'Parsing & embedding...';

        const res = await fetch('/upload', { method: 'POST', body: form });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Upload failed');

        uploadBar.style.width = '100%';
        uploadStatus.textContent = 'Done!';
        currentDocId = data.doc_id;

        setTimeout(() => {
          uploadProgress.style.display = 'none';
          uploadBar.style.width = '0%';
          activateDocument(data);
        }, 500);
      } catch (err) {
        uploadBar.style.width = '0%';
        uploadStatus.textContent = `Error: ${err.message}`;
      }
    }

    function activateDocument(data) {
      // Sidebar
      docCard.classList.add('active');
      noDocMsg.style.display = 'none';
      docName.textContent = data.filename;
      docChunks.textContent = `${data.num_chunks} chunks`;
      docIdEl.textContent = data.doc_id;
      actionsSection.style.display = 'block';
      samplesSection.style.display = 'block';

      // Chat
      chatEmpty.classList.add('hidden');
      messages.classList.add('active');
      questionInput.disabled = false;
      sendBtn.disabled = false;

      addBotMessage(`<strong>${escapeHtml(data.filename)}</strong> uploaded and indexed (${data.num_chunks} chunks). Ask me anything about this document.`);
      questionInput.focus();
    }

    // ── Chat ──
    questionInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendQuestion(); }
    });

    function askSample(el) {
      if (!currentDocId || isBusy) return;
      questionInput.value = el.textContent;
      sendQuestion();
    }

    async function sendQuestion() {
      const q = questionInput.value.trim();
      if (!q || !currentDocId || isBusy) return;

      addUserMessage(q);
      questionInput.value = '';
      isBusy = true;
      sendBtn.disabled = true;
      questionInput.disabled = true;

      const typing = addTyping();

      try {
        const res = await fetch('/ask', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ doc_id: currentDocId, question: q }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Request failed');

        typing.remove();

        const conf = data.confidence_score;
        const confClass = conf >= 0.65 ? 'high' : conf >= 0.45 ? 'med' : 'low';
        const confLabel = conf >= 0.65 ? 'High' : conf >= 0.45 ? 'Medium' : 'Low';
        const confPct = Math.round(conf * 100);

        const srcId = 'src_' + Date.now();
        let html = `<div class="answer-text">${escapeHtml(data.answer)}</div>`;
        html += `<span class="confidence ${confClass}">${confLabel} (${confPct}%)</span>`;
        if (data.source_text) {
          html += `<span class="source-toggle" onclick="document.getElementById('${srcId}').classList.toggle('open')">view source</span>`;
          html += `<div class="source" id="${srcId}">${escapeHtml(data.source_text)}</div>`;
        }
        addBotMessage(html);
      } catch (err) {
        typing.remove();
        addBotMessage(`Error: ${escapeHtml(err.message)}`);
      }

      isBusy = false;
      sendBtn.disabled = false;
      questionInput.disabled = false;
      questionInput.focus();
    }

    async function extractData() {
      if (!currentDocId || isBusy) return;

      isBusy = true;
      sendBtn.disabled = true;
      questionInput.disabled = true;

      addUserMessage('Extract structured shipment data');
      const typing = addTyping();

      try {
        const res = await fetch('/extract', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ doc_id: currentDocId }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Extraction failed');

        typing.remove();

        const fields = [
          ['Shipment ID', data.shipment_id],
          ['Shipper', data.shipper],
          ['Consignee', data.consignee],
          ['Pickup', data.pickup_datetime],
          ['Delivery', data.delivery_datetime],
          ['Equipment', data.equipment_type],
          ['Mode', data.mode],
          ['Rate', data.rate != null ? `${data.rate} ${data.currency || ''}`.trim() : null],
          ['Weight', data.weight],
          ['Carrier', data.carrier_name],
        ];

        let html = '<div class="extract-title">Extracted Shipment Data</div>';
        html += '<div class="extract-grid">';
        for (const [label, value] of fields) {
          const isNull = value == null;
          html += `<div class="extract-field">
            <div class="field-label">${escapeHtml(label)}</div>
            <div class="field-value${isNull ? ' null' : ''}">${isNull ? 'Not found' : escapeHtml(String(value))}</div>
          </div>`;
        }
        html += '</div>';

        const div = document.createElement('div');
        div.className = 'msg extract';
        div.innerHTML = html;
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
      } catch (err) {
        typing.remove();
        addBotMessage(`Error: ${escapeHtml(err.message)}`);
      }

      isBusy = false;
      sendBtn.disabled = false;
      questionInput.disabled = false;
    }

    function uploadNew() {
      currentDocId = null;
      docCard.classList.remove('active');
      noDocMsg.style.display = 'block';
      actionsSection.style.display = 'none';
      samplesSection.style.display = 'none';
      chatEmpty.classList.remove('hidden');
      messages.classList.remove('active');
      messages.innerHTML = '';
      questionInput.disabled = true;
      questionInput.value = '';
      sendBtn.disabled = true;
      fileInput.value = '';
    }

    // ── Helpers ──
    function addUserMessage(text) {
      const div = document.createElement('div');
      div.className = 'msg user';
      div.textContent = text;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    function addBotMessage(html) {
      const div = document.createElement('div');
      div.className = 'msg bot';
      div.innerHTML = html;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    function addTyping() {
      const div = document.createElement('div');
      div.className = 'msg typing';
      div.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
      return div;
    }

    function escapeHtml(text) {
      const d = document.createElement('div');
      d.textContent = text;
      return d.innerHTML;
    }
  </script>
</body>
</html>
